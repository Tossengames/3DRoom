<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Room Arranger - Mobile Friendly</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            touch-action: none; /* Prevent touch scrolling */
        }
        
        /* Mobile-first UI */
        #panel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(20, 20, 30, 0.95);
            color: white;
            padding: 15px;
            border-radius: 12px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 170, 0, 0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (min-width: 768px) {
            #panel {
            top: 20px;
            left: 20px;
            right: auto;
            width: 300px;
            max-height: 90vh;
        }
    }
    
    #panel h3 {
        margin: 0 0 15px 0;
        color: #ffaa00;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.2rem;
    }
    
    .model-section {
        margin-bottom: 15px;
    }
    
    .model-section h4 {
        margin: 10px 0;
        color: #ddd;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .model-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 8px;
        margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
        .model-list {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    .model-item {
        background: #2a2a2a;
        padding: 12px 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #444;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 5px;
        font-size: 12px;
        touch-action: manipulation;
    }
    
    .model-item:active {
        background: #ffaa00;
        color: black;
        transform: scale(0.95);
    }
    
    .model-icon {
        font-size: 24px;
    }
    
    .room-controls {
        border-top: 1px solid #444;
        padding-top: 15px;
        margin-top: 10px;
    }
    
    .dimension-inputs {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .control-group {
        flex: 1;
    }
    
    .control-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 11px;
        color: #aaa;
    }
    
    .control-group input {
        width: 100%;
        padding: 10px;
        background: #333;
        border: 1px solid #555;
        color: white;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
        -webkit-appearance: none;
    }
    
    button {
        background: #ffaa00;
        color: black;
        border: none;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
        font-size: 14px;
        touch-action: manipulation;
        margin-top: 8px;
    }
    
    button:active {
        background: #ffbb22;
        transform: scale(0.98);
    }
    
    button.secondary {
        background: #444;
        color: white;
    }
    
    #status {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 30px;
        font-size: 13px;
        z-index: 100;
        border: 1px solid #ffaa00;
        text-align: center;
        backdrop-filter: blur(5px);
        max-width: 90%;
        margin: 0 auto;
    }
    
    @media (min-width: 768px) {
        #status {
            left: 20px;
            right: auto;
            max-width: 300px;
        }
    }
    
    #stats {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.7);
        color: #ffaa00;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 11px;
        z-index: 100;
        backdrop-filter: blur(5px);
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #ffaa00;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Loading screen */
    #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #111122;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.5s;
    }
    
    #loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .loader {
        width: 50px;
        height: 50px;
        border: 3px solid #ffaa00;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loader"></div>
        <div>Loading 3D Room Arranger...</div>
        <div style="font-size: 12px; margin-top: 10px; color: #888;">Mobile optimized</div>
    </div>
    
    <div id="panel" style="display: none;">
        <h3>
            <span>üè† Room Arranger</span>
            <span style="font-size: 10px; color: #888; margin-left: auto;">v1.0</span>
        </h3>
        
        <div class="model-section">
            <h4>üì¶ Models</h4>
            <div id="model-list" class="model-list">
                <div class="model-item">
                    <span class="loading-spinner"></span>
                    <span>Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="room-controls">
            <div class="dimension-inputs">
                <div class="control-group">
                    <label>Width</label>
                    <input type="number" id="room-width" value="5" min="2" max="10" step="0.5">
                </div>
                <div class="control-group">
                    <label>Length</label>
                    <input type="number" id="room-length" value="5" min="2" max="10" step="0.5">
                </div>
            </div>
            <button id="update-room">Update Room</button>
            <button id="clear-room" class="secondary">üóëÔ∏è Clear All</button>
        </div>
    </div>
    
    <div id="status">Initializing 3D...</div>
    <div id="stats">‚ö´ Loading...</div>

    <!-- Import Three.js and required libraries -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // Hide loading screen when ready
        setTimeout(() => {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('panel').style.display = 'block';
        }, 1000);

        // --- Initialize Scene with proper setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111122); // Dark blue background

        // --- Camera with better initial view ---
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 4, 8);
        camera.lookAt(0, 1, 0);

        // --- Renderer with proper settings ---
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit for mobile performance
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        document.body.appendChild(renderer.domElement);

        // --- Controls with mobile support ---
        const orbitControls = new OrbitControls(camera, renderer.domElement);
        orbitControls.enableDamping = true;
        orbitControls.dampingFactor = 0.05;
        orbitControls.screenSpacePanning = true;
        orbitControls.maxPolarAngle = Math.PI / 2; // Prevent going under floor
        orbitControls.minDistance = 3;
        orbitControls.maxDistance = 20;
        orbitControls.enablePan = true;
        orbitControls.panSpeed = 0.8;
        orbitControls.rotateSpeed = 0.8;
        orbitControls.enableZoom = true;
        orbitControls.zoomSpeed = 1.0;
        orbitControls.touchRotate = true;
        orbitControls.touchZoom = true;
        orbitControls.touchPan = true;

        // --- Transform Controls ---
        const transformControls = new TransformControls(camera, renderer.domElement);
        transformControls.setSize(0.8);
        transformControls.addEventListener('dragging-changed', function (event) {
            orbitControls.enabled = !event.value;
        });
        
        // Snap to floor
        transformControls.addEventListener('objectChange', function () {
            if (transformControls.object) {
                transformControls.object.position.y = 0;
            }
        });
        
        scene.add(transformControls);

        // --- Lighting - This is crucial! ---
        // Ambient light for base illumination
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);

        // Main directional light (simulating sun)
        const sunLight = new THREE.DirectionalLight(0xfff5e6, 1.5);
        sunLight.position.set(5, 10, 7);
        sunLight.castShadow = true;
        sunLight.receiveShadow = true;
        sunLight.shadow.mapSize.width = 1024;
        sunLight.shadow.mapSize.height = 1024;
        sunLight.shadow.camera.near = 0.5;
        sunLight.shadow.camera.far = 20;
        sunLight.shadow.camera.left = -10;
        sunLight.shadow.camera.right = 10;
        sunLight.shadow.camera.top = 10;
        sunLight.shadow.camera.bottom = -10;
        sunLight.shadow.bias = -0.0005;
        scene.add(sunLight);

        // Fill light from the back
        const fillLight = new THREE.DirectionalLight(0x88aaff, 0.5);
        fillLight.position.set(-5, 5, -5);
        scene.add(fillLight);

        // Additional point lights for better visibility
        const pointLight1 = new THREE.PointLight(0xffaa88, 0.3);
        pointLight1.position.set(2, 3, 2);
        scene.add(pointLight1);

        const pointLight2 = new THREE.PointLight(0x88aaff, 0.3);
        pointLight2.position.set(-2, 2, -2);
        scene.add(pointLight2);

        // Add a subtle hemisphere light for sky/ground bounce
        const hemiLight = new THREE.HemisphereLight(0x88aaff, 0x332211, 0.6);
        scene.add(hemiLight);

        // --- Visual Helpers (to make sure we see something) ---
        
        // Grid helper (visible floor reference)
        const gridHelper = new THREE.GridHelper(15, 20, 0xffaa00, 0x333333);
        gridHelper.position.y = 0;
        scene.add(gridHelper);

        // Add a simple colored cube to test rendering
        const testCube = new THREE.Mesh(
            new THREE.BoxGeometry(1, 1, 1),
            new THREE.MeshStandardMaterial({ color: 0xffaa00, emissive: 0x221100 })
        );
        testCube.position.set(2, 0.5, 2);
        testCube.castShadow = true;
        testCube.receiveShadow = true;
        scene.add(testCube);
        
        // Add another cube
        const testCube2 = new THREE.Mesh(
            new THREE.BoxGeometry(1, 1, 1),
            new THREE.MeshStandardMaterial({ color: 0x44aaff })
        );
        testCube2.position.set(-2, 0.5, -2);
        testCube2.castShadow = true;
        testCube2.receiveShadow = true;
        scene.add(testCube2);

        // --- Room Container ---
        let roomGroup = new THREE.Group();
        scene.add(roomGroup);

        // --- Furniture Collection ---
        const furniture = [];

        // --- Loaders ---
        const gltfLoader = new GLTFLoader();

        // --- Create Room Function (with visible materials) ---
        function createRoom(width, length) {
            // Clear previous room
            while(roomGroup.children.length > 0) {
                roomGroup.remove(roomGroup.children[0]);
            }
            
            const wallHeight = 3;
            const wallThickness = 0.2;
            
            // Floor (visible solid floor)
            const floorGeo = new THREE.PlaneGeometry(width, length);
            const floorMat = new THREE.MeshStandardMaterial({ 
                color: 0x2a2a3a,
                roughness: 0.7,
                metalness: 0.1,
                side: THREE.DoubleSide
            });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = 0;
            floor.receiveShadow = true;
            floor.castShadow = false;
            roomGroup.add(floor);
            
            // Walls with visible colors
            const wallMat = new THREE.MeshStandardMaterial({ 
                color: 0x4a6c8f,
                roughness: 0.5,
                transparent: true,
                opacity: 0.7
            });
            
            // North wall (+Z)
            const northWall = new THREE.Mesh(new THREE.BoxGeometry(width, wallHeight, wallThickness), wallMat);
            northWall.position.set(0, wallHeight/2, length/2);
            northWall.castShadow = true;
            northWall.receiveShadow = true;
            roomGroup.add(northWall);
            
            // South wall (-Z)
            const southWall = new THREE.Mesh(new THREE.BoxGeometry(width, wallHeight, wallThickness), wallMat);
            southWall.position.set(0, wallHeight/2, -length/2);
            southWall.castShadow = true;
            southWall.receiveShadow = true;
            roomGroup.add(southWall);
            
            // East wall (+X)
            const eastWall = new THREE.Mesh(new THREE.BoxGeometry(wallThickness, wallHeight, length), wallMat);
            eastWall.position.set(width/2, wallHeight/2, 0);
            eastWall.castShadow = true;
            eastWall.receiveShadow = true;
            roomGroup.add(eastWall);
            
            // West wall (-X)
            const westWall = new THREE.Mesh(new THREE.BoxGeometry(wallThickness, wallHeight, length), wallMat);
            westWall.position.set(-width/2, wallHeight/2, 0);
            westWall.castShadow = true;
            westWall.receiveShadow = true;
            roomGroup.add(westWall);
            
            // Add colored floor markings (carpet area)
            const carpetMat = new THREE.MeshStandardMaterial({ color: 0x335577, transparent: true, opacity: 0.3 });
            const carpet = new THREE.Mesh(new THREE.PlaneGeometry(width - 0.5, length - 0.5), carpetMat);
            carpet.rotation.x = -Math.PI / 2;
            carpet.position.y = 0.01;
            roomGroup.add(carpet);
            
            // Update status
            document.getElementById('status').textContent = `Room created: ${width}m x ${length}m`;
        }

        // Initialize room
        createRoom(5, 5);

        // --- Model loading function ---
        async function loadPlaceholderModel(type) {
            // Create a visible placeholder model
            let geometry, color;
            
            switch(type) {
                case 'chair':
                    geometry = new THREE.BoxGeometry(0.8, 0.5, 0.8);
                    color = 0x8B4513;
                    break;
                case 'table':
                    geometry = new THREE.BoxGeometry(2.0, 0.2, 1.2);
                    color = 0x654321;
                    break;
                case 'sofa':
                    geometry = new THREE.BoxGeometry(2.5, 0.8, 1.0);
                    color = 0x800020;
                    break;
                case 'bed':
                    geometry = new THREE.BoxGeometry(2.2, 0.4, 1.8);
                    color = 0x446688;
                    break;
                case 'lamp':
                    geometry = new THREE.CylinderGeometry(0.3, 0.3, 1.2);
                    color = 0xFFD700;
                    break;
                default:
                    geometry = new THREE.BoxGeometry(1.0, 1.0, 1.0);
                    color = 0xcccccc;
            }
            
            const material = new THREE.MeshStandardMaterial({ 
                color: color,
                roughness: 0.4,
                metalness: 0.1,
                emissive: 0x000000
            });
            
            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            
            // Add wireframe for better visibility
            const edges = new THREE.EdgesGeometry(geometry);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 }));
            mesh.add(line);
            
            // Position
            const roomWidth = parseFloat(document.getElementById('room-width').value);
            const roomLength = parseFloat(document.getElementById('room-length').value);
            
            mesh.position.x = (Math.random() - 0.5) * (roomWidth - 1);
            mesh.position.z = (Math.random() - 0.5) * (roomLength - 1);
            mesh.position.y = geometry.parameters.height / 2; // Place on floor
            
            mesh.userData = { type: type, selectable: true };
            
            scene.add(mesh);
            furniture.push(mesh);
            
            return mesh;
        }

        // --- Available models ---
        const modelTypes = [
            { name: 'Chair', icon: 'ü™ë', file: 'chair' },
            { name: 'Table', icon: 'üçΩÔ∏è', file: 'table' },
            { name: 'Sofa', icon: 'üõãÔ∏è', file: 'sofa' },
            { name: 'Bed', icon: 'üõèÔ∏è', file: 'bed' },
            { name: 'Lamp', icon: 'üí°', file: 'lamp' },
            { name: 'Desk', icon: 'üíª', file: 'desk' }
        ];

        // Populate model list
        const modelListElement = document.getElementById('model-list');
        modelListElement.innerHTML = modelTypes.map(model => `
            <div class="model-item" data-model="${model.file}">
                <span class="model-icon">${model.icon}</span>
                <span>${model.name}</span>
            </div>
        `).join('');

        // Add click handlers
        document.querySelectorAll('.model-item').forEach(item => {
            item.addEventListener('click', async () => {
                const modelType = item.dataset.model;
                document.getElementById('status').textContent = `Adding ${modelType}...`;
                await loadPlaceholderModel(modelType);
                document.getElementById('status').textContent = `${modelType} added`;
                updateStats();
            });
        });

        // --- Raycaster for selection ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        renderer.domElement.addEventListener('click', (event) => {
            // Calculate mouse position
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(furniture);
            
            if (intersects.length > 0) {
                const selected = intersects[0].object;
                transformControls.attach(selected);
                document.getElementById('status').textContent = `Selected: ${selected.userData.type}`;
            } else {
                transformControls.detach();
            }
        });

        // Touch support for selection
        renderer.domElement.addEventListener('touchstart', (event) => {
            event.preventDefault();
            if (event.touches.length === 1) {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.touches[0].clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.touches[0].clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                
                const intersects = raycaster.intersectObjects(furniture);
                
                if (intersects.length > 0) {
                    const selected = intersects[0].object;
                    transformControls.attach(selected);
                    document.getElementById('status').textContent = `Selected: ${selected.userData.type}`;
                } else {
                    transformControls.detach();
                }
            }
        });

        // --- UI Event Listeners ---
        document.getElementById('update-room').addEventListener('click', () => {
            const width = parseFloat(document.getElementById('room-width').value);
            const length = parseFloat(document.getElementById('room-length').value);
            createRoom(width, length);
        });

        document.getElementById('clear-room').addEventListener('click', () => {
            furniture.forEach(item => scene.remove(item));
            furniture.length = 0;
            transformControls.detach();
            updateStats();
            document.getElementById('status').textContent = 'All furniture cleared';
        });

        // --- Window resize handler ---
        window.addEventListener('resize', onWindowResize, false);
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Stats update ---
        function updateStats() {
            document.getElementById('stats').innerHTML = `üì¶ ${furniture.length} items`;
        }

        // --- Add some initial furniture ---
        setTimeout(async () => {
            await loadPlaceholderModel('table');
            await loadPlaceholderModel('chair');
            await loadPlaceholderModel('lamp');
            document.getElementById('status').textContent = 'Ready - Click models to add more';
            updateStats();
        }, 1500);

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            
            orbitControls.update(); // Required for damping
            
            renderer.render(scene, camera);
        }
        
        animate();

        // Log to confirm everything is running
        console.log('Room Arranger initialized with visible scene');
    </script>
</body>
</html>